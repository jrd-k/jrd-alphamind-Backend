<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Signals WebSocket Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .connect-btn {
            background-color: #28a745;
            color: white;
        }
        .connect-btn:hover {
            background-color: #218838;
        }
        .disconnect-btn {
            background-color: #dc3545;
            color: white;
        }
        .disconnect-btn:hover {
            background-color: #c82333;
        }
        .signals-container {
            margin-top: 20px;
        }
        .signal-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .signal-info {
            flex: 1;
        }
        .signal-symbol {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
        }
        .signal-details {
            margin: 5px 0;
            color: #6c757d;
        }
        .signal-confidence {
            font-weight: bold;
        }
        .confidence-high {
            color: #28a745;
        }
        .confidence-medium {
            color: #ffc107;
        }
        .confidence-low {
            color: #dc3545;
        }
        .signal-timestamp {
            font-size: 12px;
            color: #6c757d;
        }
        .signal-action {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }
        .action-buy {
            background-color: #d4edda;
            color: #155724;
        }
        .action-sell {
            background-color: #f8d7da;
            color: #721c24;
        }
        .action-hold {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #495057;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        .log-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .log-entry {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            color: #6c757d;
        }
        .log-message {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ML Trading Signals</h1>

        <div id="status" class="status disconnected">
            Disconnected
        </div>

        <div class="controls">
            <button id="connectBtn" class="connect-btn">Connect</button>
            <button id="disconnectBtn" class="disconnect-btn" disabled>Disconnect</button>
            <span id="connectionInfo"></span>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalSignals">0</div>
                <div class="stat-label">Total Signals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="buySignals">0</div>
                <div class="stat-label">Buy Signals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="sellSignals">0</div>
                <div class="stat-label">Sell Signals</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgConfidence">0.00</div>
                <div class="stat-label">Avg Confidence</div>
            </div>
        </div>

        <div class="signals-container">
            <h2>Recent Signals</h2>
            <div id="signalsList">
                <p>No signals received yet. Connect to start receiving ML signals.</p>
            </div>
        </div>

        <div class="log-container">
            <div id="log">
                <div class="log-entry">
                    <span class="log-timestamp">00:00:00</span>
                    <span class="log-message">WebSocket client initialized</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MLSignalsClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.signals = [];
                this.stats = {
                    total: 0,
                    buy: 0,
                    sell: 0,
                    confidenceSum: 0
                };

                this.connectBtn = document.getElementById('connectBtn');
                this.disconnectBtn = document.getElementById('disconnectBtn');
                this.statusDiv = document.getElementById('status');
                this.connectionInfo = document.getElementById('connectionInfo');
                this.signalsList = document.getElementById('signalsList');

                this.bindEvents();
            }

            bindEvents() {
                this.connectBtn.addEventListener('click', () => this.connect());
                this.disconnectBtn.addEventListener('click', () => this.disconnect());
            }

            connect() {
                if (this.isConnected) return;

                this.updateStatus('connecting', 'Connecting...');
                this.connectBtn.disabled = true;

                // Change this URL to match your backend
                const wsUrl = 'ws://localhost:8000/api/v1/ws/ml-signals';

                try {
                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateStatus('connected', 'Connected to ML signals stream');
                        this.connectBtn.disabled = true;
                        this.disconnectBtn.disabled = false;
                        this.log('Connected to WebSocket');
                    };

                    this.ws.onmessage = (event) => {
                        try {
                            const signal = JSON.parse(event.data);
                            this.handleSignal(signal);
                        } catch (e) {
                            this.log(`Error parsing message: ${e.message}`);
                        }
                    };

                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateStatus('disconnected', 'Disconnected');
                        this.connectBtn.disabled = false;
                        this.disconnectBtn.disabled = true;
                        this.log('WebSocket connection closed');
                    };

                    this.ws.onerror = (error) => {
                        this.log(`WebSocket error: ${error}`);
                        this.updateStatus('disconnected', 'Connection error');
                    };

                } catch (e) {
                    this.log(`Failed to create WebSocket: ${e.message}`);
                    this.updateStatus('disconnected', 'Failed to connect');
                    this.connectBtn.disabled = false;
                }
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                }
            }

            handleSignal(signal) {
                this.log(`Received signal: ${JSON.stringify(signal)}`);

                // Add to signals array
                this.signals.unshift(signal);
                if (this.signals.length > 50) {
                    this.signals = this.signals.slice(0, 50); // Keep only last 50
                }

                // Update stats
                this.updateStats(signal);

                // Update UI
                this.renderSignals();
            }

            updateStats(signal) {
                this.stats.total++;

                if (signal.signal === 'BUY') {
                    this.stats.buy++;
                } else if (signal.signal === 'SELL') {
                    this.stats.sell++;
                }

                if (signal.confidence) {
                    this.stats.confidenceSum += signal.confidence;
                }

                // Update DOM
                document.getElementById('totalSignals').textContent = this.stats.total;
                document.getElementById('buySignals').textContent = this.stats.buy;
                document.getElementById('sellSignals').textContent = this.stats.sell;

                const avgConfidence = this.stats.total > 0 ?
                    (this.stats.confidenceSum / this.stats.total).toFixed(2) : '0.00';
                document.getElementById('avgConfidence').textContent = avgConfidence;
            }

            renderSignals() {
                if (this.signals.length === 0) {
                    this.signalsList.innerHTML = '<p>No signals received yet.</p>';
                    return;
                }

                const signalsHtml = this.signals.map(signal => this.createSignalCard(signal)).join('');
                this.signalsList.innerHTML = signalsHtml;
            }

            createSignalCard(signal) {
                const confidence = signal.confidence || 0;
                const confidenceClass = confidence > 0.7 ? 'confidence-high' :
                                      confidence > 0.5 ? 'confidence-medium' : 'confidence-low';

                const actionClass = signal.signal === 'BUY' ? 'action-buy' :
                                  signal.signal === 'SELL' ? 'action-sell' : 'action-hold';

                const timestamp = new Date(signal.timestamp).toLocaleTimeString();

                return `
                    <div class="signal-card">
                        <div class="signal-info">
                            <div class="signal-symbol">${signal.symbol || 'Unknown'}</div>
                            <div class="signal-details">
                                Confidence: <span class="signal-confidence ${confidenceClass}">${(confidence * 100).toFixed(1)}%</span>
                                ${signal.prediction ? ` | Prediction: ${signal.prediction}` : ''}
                            </div>
                            <div class="signal-timestamp">${timestamp}</div>
                        </div>
                        <div class="signal-action ${actionClass}">
                            ${signal.signal || 'HOLD'}
                        </div>
                    </div>
                `;
            }

            updateStatus(status, message) {
                this.statusDiv.className = `status ${status}`;
                this.statusDiv.textContent = message;
                this.connectionInfo.textContent = status === 'connected' ?
                    'Receiving ML signals...' : '';
            }

            log(message) {
                const log = document.getElementById('log');
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.innerHTML = `
                    <span class="log-timestamp">${timestamp}</span>
                    <span class="log-message">${message}</span>
                `;

                log.appendChild(entry);
                log.scrollTop = log.scrollHeight;

                // Keep only last 100 log entries
                while (log.children.length > 100) {
                    log.removeChild(log.firstChild);
                }
            }
        }

        // Initialize client when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MLSignalsClient();
        });
    </script>
</body>
</html>